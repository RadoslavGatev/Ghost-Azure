{"version":3,"file":"modules.js","sources":["../../../src/integrations/modules.ts"],"sourcesContent":["import type { EventProcessor, Hub, Integration } from '@sentry/types';\nimport { existsSync, readFileSync } from 'fs';\nimport { dirname, join } from 'path';\n\nlet moduleCache: { [key: string]: string };\n\n/** Extract information about paths */\nfunction getPaths(): string[] {\n  try {\n    return require.cache ? Object.keys(require.cache as Record<string, unknown>) : [];\n  } catch (e) {\n    return [];\n  }\n}\n\n/** Extract information about package.json modules */\nfunction collectModules(): {\n  [name: string]: string;\n} {\n  const mainPaths = (require.main && require.main.paths) || [];\n  const paths = getPaths();\n  const infos: {\n    [name: string]: string;\n  } = {};\n  const seen: {\n    [path: string]: boolean;\n  } = {};\n\n  paths.forEach(path => {\n    let dir = path;\n\n    /** Traverse directories upward in the search of package.json file */\n    const updir = (): void | (() => void) => {\n      const orig = dir;\n      dir = dirname(orig);\n\n      if (!dir || orig === dir || seen[orig]) {\n        return undefined;\n      }\n      if (mainPaths.indexOf(dir) < 0) {\n        return updir();\n      }\n\n      const pkgfile = join(orig, 'package.json');\n      seen[orig] = true;\n\n      if (!existsSync(pkgfile)) {\n        return updir();\n      }\n\n      try {\n        const info = JSON.parse(readFileSync(pkgfile, 'utf8')) as {\n          name: string;\n          version: string;\n        };\n        infos[info.name] = info.version;\n      } catch (_oO) {\n        // no-empty\n      }\n    };\n\n    updir();\n  });\n\n  return infos;\n}\n\n/** Add node modules / packages to the event */\nexport class Modules implements Integration {\n  /**\n   * @inheritDoc\n   */\n  public static id: string = 'Modules';\n\n  /**\n   * @inheritDoc\n   */\n  public name: string = Modules.id;\n\n  /**\n   * @inheritDoc\n   */\n  public setupOnce(addGlobalEventProcessor: (callback: EventProcessor) => void, getCurrentHub: () => Hub): void {\n    addGlobalEventProcessor(event => {\n      if (!getCurrentHub().getIntegration(Modules)) {\n        return event;\n      }\n      return {\n        ...event,\n        modules: {\n          ...event.modules,\n          ...this._getModules(),\n        },\n      };\n    });\n  }\n\n  /** Fetches the list of modules and the versions loaded by the entry file for your node.js app. */\n  private _getModules(): { [key: string]: string } {\n    if (!moduleCache) {\n      moduleCache = collectModules();\n    }\n    return moduleCache;\n  }\n}\n"],"names":[],"mappings":";;;AAIA,IAAA,WAAA,CAAA;AACA;AACA;AACA,SAAA,QAAA,GAAA;AACA,EAAA,IAAA;AACA,IAAA,OAAA,OAAA,CAAA,KAAA,GAAA,MAAA,CAAA,IAAA,CAAA,OAAA,CAAA,KAAA,EAAA,GAAA,EAAA,CAAA;AACA,GAAA,CAAA,OAAA,CAAA,EAAA;AACA,IAAA,OAAA,EAAA,CAAA;AACA,GAAA;AACA,CAAA;AACA;AACA;AACA,SAAA,cAAA;AACA;AACA,CAAA;AACA,EAAA,MAAA,SAAA,GAAA,CAAA,OAAA,CAAA,IAAA,IAAA,OAAA,CAAA,IAAA,CAAA,KAAA,KAAA,EAAA,CAAA;AACA,EAAA,MAAA,KAAA,GAAA,QAAA,EAAA,CAAA;AACA,EAAA,MAAA,KAAA;AACA;AACA,GAAA,EAAA,CAAA;AACA,EAAA,MAAA,IAAA;AACA;AACA,GAAA,EAAA,CAAA;AACA;AACA,EAAA,KAAA,CAAA,OAAA,CAAA,IAAA,IAAA;AACA,IAAA,IAAA,GAAA,GAAA,IAAA,CAAA;AACA;AACA;AACA,IAAA,MAAA,KAAA,GAAA,MAAA;AACA,MAAA,MAAA,IAAA,GAAA,GAAA,CAAA;AACA,MAAA,GAAA,GAAA,OAAA,CAAA,IAAA,CAAA,CAAA;AACA;AACA,MAAA,IAAA,CAAA,GAAA,IAAA,IAAA,KAAA,GAAA,IAAA,IAAA,CAAA,IAAA,CAAA,EAAA;AACA,QAAA,OAAA,SAAA,CAAA;AACA,OAAA;AACA,MAAA,IAAA,SAAA,CAAA,OAAA,CAAA,GAAA,CAAA,GAAA,CAAA,EAAA;AACA,QAAA,OAAA,KAAA,EAAA,CAAA;AACA,OAAA;AACA;AACA,MAAA,MAAA,OAAA,GAAA,IAAA,CAAA,IAAA,EAAA,cAAA,CAAA,CAAA;AACA,MAAA,IAAA,CAAA,IAAA,CAAA,GAAA,IAAA,CAAA;AACA;AACA,MAAA,IAAA,CAAA,UAAA,CAAA,OAAA,CAAA,EAAA;AACA,QAAA,OAAA,KAAA,EAAA,CAAA;AACA,OAAA;AACA;AACA,MAAA,IAAA;AACA,QAAA,MAAA,IAAA,GAAA,IAAA,CAAA,KAAA,CAAA,YAAA,CAAA,OAAA,EAAA,MAAA,CAAA,CAAA;;AAGA,CAAA;AACA,QAAA,KAAA,CAAA,IAAA,CAAA,IAAA,CAAA,GAAA,IAAA,CAAA,OAAA,CAAA;AACA,OAAA,CAAA,OAAA,GAAA,EAAA;AACA;AACA,OAAA;AACA,KAAA,CAAA;AACA;AACA,IAAA,KAAA,EAAA,CAAA;AACA,GAAA,CAAA,CAAA;AACA;AACA,EAAA,OAAA,KAAA,CAAA;AACA,CAAA;AACA;AACA;AACA,MAAA,OAAA,EAAA,CAAA,WAAA,GAAA,EAAA,OAAA,CAAA,SAAA,CAAA,MAAA,CAAA,IAAA,CAAA,IAAA,CAAA,CAAA,EAAA;AACA;AACA;AACA;AACA,GAAA,OAAA,YAAA,GAAA,CAAA,IAAA,CAAA,EAAA,GAAA,UAAA,CAAA;AACA;AACA;AACA;AACA;AACA,GAAA,MAAA,GAAA,CAAA,IAAA,CAAA,IAAA,GAAA,OAAA,CAAA,GAAA,CAAA;AACA;AACA;AACA;AACA;AACA,GAAA,SAAA,CAAA,uBAAA,EAAA,aAAA,EAAA;AACA,IAAA,uBAAA,CAAA,KAAA,IAAA;AACA,MAAA,IAAA,CAAA,aAAA,EAAA,CAAA,cAAA,CAAA,OAAA,CAAA,EAAA;AACA,QAAA,OAAA,KAAA,CAAA;AACA,OAAA;AACA,MAAA,OAAA;AACA,QAAA,GAAA,KAAA;AACA,QAAA,OAAA,EAAA;AACA,UAAA,GAAA,KAAA,CAAA,OAAA;AACA,UAAA,GAAA,IAAA,CAAA,WAAA,EAAA;AACA,SAAA;AACA,OAAA,CAAA;AACA,KAAA,CAAA,CAAA;AACA,GAAA;AACA;AACA;AACA,GAAA,WAAA,GAAA;AACA,IAAA,IAAA,CAAA,WAAA,EAAA;AACA,MAAA,WAAA,GAAA,cAAA,EAAA,CAAA;AACA,KAAA;AACA,IAAA,OAAA,WAAA,CAAA;AACA,GAAA;AACA,CAAA,CAAA,OAAA,CAAA,YAAA,EAAA;;;;"}