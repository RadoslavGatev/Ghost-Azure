{"version":3,"file":"integration.js","sources":["../../src/integration.ts"],"sourcesContent":["import type { Integration, Options } from '@sentry/types';\nimport { arrayify, logger } from '@sentry/utils';\n\nimport { getCurrentHub } from './hub';\nimport { addGlobalEventProcessor } from './scope';\n\ndeclare module '@sentry/types' {\n  interface Integration {\n    isDefaultInstance?: boolean;\n  }\n}\n\nexport const installedIntegrations: string[] = [];\n\n/** Map of integrations assigned to a client */\nexport type IntegrationIndex = {\n  [key: string]: Integration;\n};\n\n/**\n * Remove duplicates from the given array, preferring the last instance of any duplicate. Not guaranteed to\n * preseve the order of integrations in the array.\n *\n * @private\n */\nfunction filterDuplicates(integrations: Integration[]): Integration[] {\n  const integrationsByName: { [key: string]: Integration } = {};\n\n  integrations.forEach(currentInstance => {\n    const { name } = currentInstance;\n\n    const existingInstance = integrationsByName[name];\n\n    // We want integrations later in the array to overwrite earlier ones of the same type, except that we never want a\n    // default instance to overwrite an existing user instance\n    if (existingInstance && !existingInstance.isDefaultInstance && currentInstance.isDefaultInstance) {\n      return;\n    }\n\n    integrationsByName[name] = currentInstance;\n  });\n\n  return Object.values(integrationsByName);\n}\n\n/** Gets integrations to install */\nexport function getIntegrationsToSetup(options: Options): Integration[] {\n  const defaultIntegrations = options.defaultIntegrations || [];\n  const userIntegrations = options.integrations;\n\n  // We flag default instances, so that later we can tell them apart from any user-created instances of the same class\n  defaultIntegrations.forEach(integration => {\n    integration.isDefaultInstance = true;\n  });\n\n  let integrations: Integration[];\n\n  if (Array.isArray(userIntegrations)) {\n    integrations = [...defaultIntegrations, ...userIntegrations];\n  } else if (typeof userIntegrations === 'function') {\n    integrations = arrayify(userIntegrations(defaultIntegrations));\n  } else {\n    integrations = defaultIntegrations;\n  }\n\n  const finalIntegrations = filterDuplicates(integrations);\n\n  // The `Debug` integration prints copies of the `event` and `hint` which will be passed to `beforeSend` or\n  // `beforeSendTransaction`. It therefore has to run after all other integrations, so that the changes of all event\n  // processors will be reflected in the printed values. For lack of a more elegant way to guarantee that, we therefore\n  // locate it and, assuming it exists, pop it out of its current spot and shove it onto the end of the array.\n  const debugIndex = finalIntegrations.findIndex(integration => integration.name === 'Debug');\n  if (debugIndex !== -1) {\n    const [debugInstance] = finalIntegrations.splice(debugIndex, 1);\n    finalIntegrations.push(debugInstance);\n  }\n\n  return finalIntegrations;\n}\n\n/**\n * Given a list of integration instances this installs them all. When `withDefaults` is set to `true` then all default\n * integrations are added unless they were already provided before.\n * @param integrations array of integration instances\n * @param withDefault should enable default integrations\n */\nexport function setupIntegrations(integrations: Integration[]): IntegrationIndex {\n  const integrationIndex: IntegrationIndex = {};\n\n  integrations.forEach(integration => {\n    // guard against empty provided integrations\n    if (integration) {\n      setupIntegration(integration, integrationIndex);\n    }\n  });\n\n  return integrationIndex;\n}\n\n/** Setup a single integration.  */\nexport function setupIntegration(integration: Integration, integrationIndex: IntegrationIndex): void {\n  integrationIndex[integration.name] = integration;\n\n  if (installedIntegrations.indexOf(integration.name) === -1) {\n    integration.setupOnce(addGlobalEventProcessor, getCurrentHub);\n    installedIntegrations.push(integration.name);\n    __DEBUG_BUILD__ && logger.log(`Integration installed: ${integration.name}`);\n  }\n}\n"],"names":[],"mappings":";;;;AAYA,MAAA,qBAAA,GAAA,GAAA;AACA;AACA;;AAKA;AACA;AACA;AACA;AACA;AACA;AACA,SAAA,gBAAA,CAAA,YAAA,EAAA;AACA,EAAA,MAAA,kBAAA,GAAA,EAAA,CAAA;AACA;AACA,EAAA,YAAA,CAAA,OAAA,CAAA,eAAA,IAAA;AACA,IAAA,MAAA,EAAA,IAAA,EAAA,GAAA,eAAA,CAAA;AACA;AACA,IAAA,MAAA,gBAAA,GAAA,kBAAA,CAAA,IAAA,CAAA,CAAA;AACA;AACA;AACA;AACA,IAAA,IAAA,gBAAA,IAAA,CAAA,gBAAA,CAAA,iBAAA,IAAA,eAAA,CAAA,iBAAA,EAAA;AACA,MAAA,OAAA;AACA,KAAA;AACA;AACA,IAAA,kBAAA,CAAA,IAAA,CAAA,GAAA,eAAA,CAAA;AACA,GAAA,CAAA,CAAA;AACA;AACA,EAAA,OAAA,MAAA,CAAA,MAAA,CAAA,kBAAA,CAAA,CAAA;AACA,CAAA;AACA;AACA;AACA,SAAA,sBAAA,CAAA,OAAA,EAAA;AACA,EAAA,MAAA,mBAAA,GAAA,OAAA,CAAA,mBAAA,IAAA,EAAA,CAAA;AACA,EAAA,MAAA,gBAAA,GAAA,OAAA,CAAA,YAAA,CAAA;AACA;AACA;AACA,EAAA,mBAAA,CAAA,OAAA,CAAA,WAAA,IAAA;AACA,IAAA,WAAA,CAAA,iBAAA,GAAA,IAAA,CAAA;AACA,GAAA,CAAA,CAAA;AACA;AACA,EAAA,IAAA,YAAA,CAAA;AACA;AACA,EAAA,IAAA,KAAA,CAAA,OAAA,CAAA,gBAAA,CAAA,EAAA;AACA,IAAA,YAAA,GAAA,CAAA,GAAA,mBAAA,EAAA,GAAA,gBAAA,CAAA,CAAA;AACA,GAAA,MAAA,IAAA,OAAA,gBAAA,KAAA,UAAA,EAAA;AACA,IAAA,YAAA,GAAA,QAAA,CAAA,gBAAA,CAAA,mBAAA,CAAA,CAAA,CAAA;AACA,GAAA,MAAA;AACA,IAAA,YAAA,GAAA,mBAAA,CAAA;AACA,GAAA;AACA;AACA,EAAA,MAAA,iBAAA,GAAA,gBAAA,CAAA,YAAA,CAAA,CAAA;AACA;AACA;AACA;AACA;AACA;AACA,EAAA,MAAA,UAAA,GAAA,iBAAA,CAAA,SAAA,CAAA,WAAA,IAAA,WAAA,CAAA,IAAA,KAAA,OAAA,CAAA,CAAA;AACA,EAAA,IAAA,UAAA,KAAA,CAAA,CAAA,EAAA;AACA,IAAA,MAAA,CAAA,aAAA,CAAA,GAAA,iBAAA,CAAA,MAAA,CAAA,UAAA,EAAA,CAAA,CAAA,CAAA;AACA,IAAA,iBAAA,CAAA,IAAA,CAAA,aAAA,CAAA,CAAA;AACA,GAAA;AACA;AACA,EAAA,OAAA,iBAAA,CAAA;AACA,CAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAA,iBAAA,CAAA,YAAA,EAAA;AACA,EAAA,MAAA,gBAAA,GAAA,EAAA,CAAA;AACA;AACA,EAAA,YAAA,CAAA,OAAA,CAAA,WAAA,IAAA;AACA;AACA,IAAA,IAAA,WAAA,EAAA;AACA,MAAA,gBAAA,CAAA,WAAA,EAAA,gBAAA,CAAA,CAAA;AACA,KAAA;AACA,GAAA,CAAA,CAAA;AACA;AACA,EAAA,OAAA,gBAAA,CAAA;AACA,CAAA;AACA;AACA;AACA,SAAA,gBAAA,CAAA,WAAA,EAAA,gBAAA,EAAA;AACA,EAAA,gBAAA,CAAA,WAAA,CAAA,IAAA,CAAA,GAAA,WAAA,CAAA;AACA;AACA,EAAA,IAAA,qBAAA,CAAA,OAAA,CAAA,WAAA,CAAA,IAAA,CAAA,KAAA,CAAA,CAAA,EAAA;AACA,IAAA,WAAA,CAAA,SAAA,CAAA,uBAAA,EAAA,aAAA,CAAA,CAAA;AACA,IAAA,qBAAA,CAAA,IAAA,CAAA,WAAA,CAAA,IAAA,CAAA,CAAA;AACA,IAAA,CAAA,OAAA,gBAAA,KAAA,WAAA,IAAA,gBAAA,KAAA,MAAA,CAAA,GAAA,CAAA,CAAA,uBAAA,EAAA,WAAA,CAAA,IAAA,CAAA,CAAA,CAAA,CAAA;AACA,GAAA;AACA;;;;"}