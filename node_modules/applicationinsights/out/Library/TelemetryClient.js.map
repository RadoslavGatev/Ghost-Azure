{"version":3,"file":"TelemetryClient.js","sourceRoot":"","sources":["../../Library/TelemetryClient.ts"],"names":[],"mappings":"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","sourcesContent":["import url = require(\"url\");\r\nimport os = require(\"os\");\r\n\r\nimport Config = require(\"./Config\");\r\nimport Context = require(\"./Context\");\r\nimport Contracts = require(\"../Declarations/Contracts\");\r\nimport Channel = require(\"./Channel\");\r\nimport TelemetryProcessors = require(\"../TelemetryProcessors\");\r\nimport { CorrelationContextManager } from \"../AutoCollection/CorrelationContextManager\";\r\nimport Sender = require(\"./Sender\");\r\nimport Util = require(\"./Util\");\r\nimport Logging = require(\"./Logging\");\r\nimport FlushOptions = require(\"./FlushOptions\");\r\nimport EnvelopeFactory = require(\"./EnvelopeFactory\");\r\nimport QuickPulseStateManager = require(\"./QuickPulseStateManager\");\r\n\r\n/**\r\n * Application Insights telemetry client provides interface to track telemetry items, register telemetry initializers and\r\n * and manually trigger immediate sending (flushing)\r\n */\r\nclass TelemetryClient {\r\n    private _telemetryProcessors: { (envelope: Contracts.EnvelopeTelemetry, contextObjects: { [name: string]: any; }): boolean; }[] = [];\r\n    private _enableAzureProperties: boolean = false;\r\n\r\n    public config: Config;\r\n    public context: Context;\r\n    public commonProperties: { [key: string]: string; };\r\n    public channel: Channel;\r\n    public quickPulseClient: QuickPulseStateManager;\r\n\r\n    /**\r\n     * Constructs a new client of the client\r\n     * @param setupString the Connection String or Instrumentation Key to use (read from environment variable if not specified)\r\n     */\r\n    constructor(setupString?: string) {\r\n        var config = new Config(setupString);\r\n        this.config = config;\r\n        this.context = new Context();\r\n        this.commonProperties = {};\r\n\r\n        var sender = new Sender(this.config);\r\n        this.channel = new Channel(() => config.disableAppInsights, () => config.maxBatchSize, () => config.maxBatchIntervalMs, sender);\r\n    }\r\n\r\n    /**\r\n     * Log information about availability of an application\r\n     * @param telemetry      Object encapsulating tracking options\r\n     */\r\n    public trackAvailability(telemetry: Contracts.AvailabilityTelemetry): void {\r\n        this.track(telemetry, Contracts.TelemetryType.Availability);\r\n    }\r\n\r\n    /**\r\n     * Log a page view\r\n     * @param telemetry      Object encapsulating tracking options\r\n     */\r\n    public trackPageView(telemetry: Contracts.PageViewTelemetry): void {\r\n        this.track(telemetry, Contracts.TelemetryType.PageView);\r\n    }\r\n\r\n    /**\r\n     * Log a trace message\r\n     * @param telemetry      Object encapsulating tracking options\r\n     */\r\n    public trackTrace(telemetry: Contracts.TraceTelemetry): void {\r\n        this.track(telemetry, Contracts.TelemetryType.Trace);\r\n    }\r\n\r\n    /**\r\n     * Log a numeric value that is not associated with a specific event. Typically used to send regular reports of performance indicators.\r\n     * To send a single measurement, use just the first two parameters. If you take measurements very frequently, you can reduce the\r\n     * telemetry bandwidth by aggregating multiple measurements and sending the resulting average at intervals.\r\n     * @param telemetry      Object encapsulating tracking options\r\n     */\r\n    public trackMetric(telemetry: Contracts.MetricTelemetry): void {\r\n        this.track(telemetry, Contracts.TelemetryType.Metric);\r\n    }\r\n\r\n    /**\r\n     * Log an exception\r\n     * @param telemetry      Object encapsulating tracking options\r\n     */\r\n    public trackException(telemetry: Contracts.ExceptionTelemetry): void {\r\n        if (telemetry && telemetry.exception && !Util.isError(telemetry.exception)) {\r\n            telemetry.exception = new Error(telemetry.exception.toString());\r\n        }\r\n        this.track(telemetry, Contracts.TelemetryType.Exception);\r\n    }\r\n\r\n    /**\r\n     * Log a user action or other occurrence.\r\n     * @param telemetry      Object encapsulating tracking options\r\n     */\r\n    public trackEvent(telemetry: Contracts.EventTelemetry): void {\r\n        this.track(telemetry, Contracts.TelemetryType.Event);\r\n    }\r\n\r\n    /**\r\n     * Log a request. Note that the default client will attempt to collect HTTP requests automatically so only use this for requests\r\n     * that aren't automatically captured or if you've disabled automatic request collection.\r\n     *\r\n     * @param telemetry      Object encapsulating tracking options\r\n     */\r\n    public trackRequest(telemetry: Contracts.RequestTelemetry & Contracts.Identified): void {\r\n        this.track(telemetry, Contracts.TelemetryType.Request);\r\n    }\r\n\r\n    /**\r\n     * Log a dependency. Note that the default client will attempt to collect dependencies automatically so only use this for dependencies\r\n     * that aren't automatically captured or if you've disabled automatic dependency collection.\r\n     *\r\n     * @param telemetry      Object encapsulating tracking option\r\n     * */\r\n    public trackDependency(telemetry: Contracts.DependencyTelemetry & Contracts.Identified) {\r\n\r\n        if (telemetry && !telemetry.target && telemetry.data) {\r\n            // url.parse().host returns null for non-urls,\r\n            // making this essentially a no-op in those cases\r\n            // If this logic is moved, update jsdoc in DependencyTelemetry.target\r\n            telemetry.target = url.parse(telemetry.data).host;\r\n        }\r\n        this.track(telemetry, Contracts.TelemetryType.Dependency);\r\n    }\r\n\r\n    /**\r\n     * Immediately send all queued telemetry.\r\n     * @param options Flush options, including indicator whether app is crashing and callback\r\n     */\r\n    public flush(options?: FlushOptions) {\r\n        this.channel.triggerSend(\r\n            options ? !!options.isAppCrashing : false,\r\n            options ? options.callback : undefined);\r\n    }\r\n\r\n    /**\r\n     * Generic track method for all telemetry types\r\n     * @param data the telemetry to send\r\n     * @param telemetryType specify the type of telemetry you are tracking from the list of Contracts.DataTypes\r\n     */\r\n    public track(telemetry: Contracts.Telemetry, telemetryType: Contracts.TelemetryType) {\r\n        if (telemetry && Contracts.telemetryTypeToBaseType(telemetryType)) {\r\n            var envelope = EnvelopeFactory.createEnvelope(telemetry, telemetryType, this.commonProperties, this.context, this.config);\r\n\r\n            // Set time on the envelope if it was set on the telemetry item\r\n            if (telemetry.time) {\r\n                envelope.time = telemetry.time.toISOString();\r\n            }\r\n            if (this._enableAzureProperties) {\r\n                TelemetryProcessors.azureRoleEnvironmentTelemetryProcessor(envelope, this.context);\r\n            }\r\n            var accepted = this.runTelemetryProcessors(envelope, telemetry.contextObjects);\r\n\r\n            // Ideally we would have a central place for \"internal\" telemetry processors and users can configure which ones are in use.\r\n            // This will do for now. Otherwise clearTelemetryProcessors() would be problematic.\r\n            accepted = accepted && TelemetryProcessors.samplingTelemetryProcessor(envelope, { correlationContext: CorrelationContextManager.getCurrentContext() });\r\n\r\n            if (accepted) {\r\n                TelemetryProcessors.performanceMetricsTelemetryProcessor(envelope, this.quickPulseClient);\r\n                this.channel.send(envelope);\r\n            }\r\n        }\r\n        else {\r\n            Logging.warn(\"track() requires telemetry object and telemetryType to be specified.\")\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Automatically populate telemetry properties like RoleName when running in Azure\r\n     *\r\n      * @param value if true properties will be populated\r\n     */\r\n    public setAutoPopulateAzureProperties(value: boolean) {\r\n        this._enableAzureProperties = value;\r\n    }\r\n\r\n    /**\r\n     * Adds telemetry processor to the collection. Telemetry processors will be called one by one\r\n     * before telemetry item is pushed for sending and in the order they were added.\r\n     *\r\n     * @param telemetryProcessor function, takes Envelope, and optional context object and returns boolean\r\n     */\r\n    public addTelemetryProcessor(telemetryProcessor: (envelope: Contracts.EnvelopeTelemetry, contextObjects?: { [name: string]: any; }) => boolean) {\r\n        this._telemetryProcessors.push(telemetryProcessor);\r\n    }\r\n\r\n    /*\r\n     * Removes all telemetry processors\r\n     */\r\n    public clearTelemetryProcessors() {\r\n        this._telemetryProcessors = [];\r\n    }\r\n\r\n    private runTelemetryProcessors(envelope: Contracts.EnvelopeTelemetry, contextObjects: { [name: string]: any; }): boolean {\r\n        var accepted = true;\r\n        var telemetryProcessorsCount = this._telemetryProcessors.length;\r\n\r\n        if (telemetryProcessorsCount === 0) {\r\n            return accepted;\r\n        }\r\n\r\n        contextObjects = contextObjects || {};\r\n        contextObjects['correlationContext'] = CorrelationContextManager.getCurrentContext();\r\n\r\n        for (var i = 0; i < telemetryProcessorsCount; ++i) {\r\n            try {\r\n                var processor = this._telemetryProcessors[i];\r\n                if (processor) {\r\n                    if (processor.apply(null, [envelope, contextObjects]) === false) {\r\n                        accepted = false;\r\n                        break;\r\n                    }\r\n                }\r\n\r\n            } catch (error) {\r\n                accepted = true;\r\n                Logging.warn(\"One of telemetry processors failed, telemetry item will be sent.\", error, envelope);\r\n            }\r\n        }\r\n\r\n        return accepted;\r\n    }\r\n}\r\n\r\nexport = TelemetryClient;\r\n"]}